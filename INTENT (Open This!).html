<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTENT Data Manager</title>
    <style>
        :root {
            --bg: #050816;
            --bg-elevated: #0b1020;
            --bg-elevated-2: #111827;
            --accent: #4f46e5;
            --accent-soft: rgba(79, 70, 229, 0.2);
            --accent-soft-2: rgba(79, 70, 229, 0.4);
            --accent-strong: #a855f7;
            --border-subtle: #1f2937;
            --border-strong: #374151;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --text-soft: #6b7280;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.6);
            --radius-lg: 18px;
            --radius-md: 12px;
            --radius-pill: 999px;
        }

        * { box-sizing: border-box; }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: radial-gradient(circle at top left, #111827 0, #020617 45%, #000 100%);
            color: var(--text-main);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body { display: flex; flex-direction: column; overflow: hidden; }
        .app-shell { display: flex; height: 100vh; }

        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #020617 0%, #050816 45%, #020617 100%);
            border-right: 1px solid var(--border-subtle);
            padding: 14px 10px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 6px 10px;
        }

        .sidebar-title {
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .data-type-selector {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: var(--radius-pill);
            border: 1px solid var(--border-subtle);
            margin-bottom: 8px;
        }

        .data-type-btn {
            flex: 1;
            padding: 6px 8px;
            font-size: 10px;
            font-weight: 600;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: var(--radius-pill);
            cursor: pointer;
            transition: all 0.2s;
        }

        .data-type-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
        }

        .entries-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-height: 0;
        }

        .entry-item {
            padding: 8px 10px;
            border-radius: var(--radius-md);
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .entry-item:hover {
            background: rgba(55, 65, 81, 0.4);
            border-color: rgba(148, 163, 184, 0.4);
        }

        .entry-item.active {
            background: rgba(79, 70, 229, 0.3);
            border-color: rgba(129, 140, 248, 0.7);
        }

        .entry-item.shift-item {
            margin-left: 20px;
            border-left: 3px solid var(--accent);
            padding-left: 8px;
        }

        .entry-item.shift-item::before {
            content: '‚Ü≥';
            position: absolute;
            left: -15px;
            color: var(--accent);
            font-size: 14px;
        }

        .entry-item-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .entry-item-subtitle {
            font-size: 10px;
            color: var(--text-soft);
        }

        .group-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
            vertical-align: middle;
        }

        .sidebar-footer {
            display: flex;
            gap: 6px;
            padding-top: 8px;
            border-top: 1px solid var(--border-subtle);
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
            background: linear-gradient(180deg, rgba(2, 6, 23, 0.0), rgba(5, 8, 22, 0.98));
        }

        .pill-button {
            border-radius: var(--radius-pill);
            border: 1px solid var(--border-subtle);
            background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.45), rgba(15, 23, 42, 0.95));
            color: #f9fafb;
            font-size: 12px;
            padding: 6px 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.1);
            transition: all 0.2s;
        }

        .pill-button:hover {
            background: radial-gradient(circle at top left, rgba(168, 183, 204, 0.55), rgba(25, 33, 52, 0.95));
            border-color: var(--accent-soft-2);
        }

        .pill-button.small {
            font-size: 11px;
            padding: 4px 10px;
        }

        .pill-button.danger {
            background: radial-gradient(circle at top left, rgba(239, 68, 68, 0.3), rgba(15, 23, 42, 0.95));
            border-color: rgba(239, 68, 68, 0.4);
        }

        .pill-button.danger:hover {
            background: radial-gradient(circle at top left, rgba(239, 68, 68, 0.5), rgba(25, 33, 52, 0.95));
        }

        .pill-button.success {
            background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.3), rgba(15, 23, 42, 0.95));
            border-color: rgba(34, 197, 94, 0.4);
        }

        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-header {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(7, 11, 21, 0.98) 100%);
            border-bottom: 1px solid var(--border-subtle);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .brand-block {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .brand-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.02em;
            background: linear-gradient(135deg, #e0e7ff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .brand-subtitle {
            font-size: 11px;
            color: var(--text-soft);
        }

        .tab-toggle {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: var(--radius-pill);
            border: 1px solid var(--border-subtle);
        }

        .tab-button {
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: var(--radius-pill);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .editor-card {
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-soft);
        }

        .form-section {
            margin-bottom: 24px;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.02em;
            color: var(--text-main);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-help {
            font-size: 11px;
            color: var(--text-soft);
            margin-top: 4px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-main);
            font-size: 13px;
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--accent-soft-2);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .radio-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .radio-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-pill);
            border: 1px solid var(--border-subtle);
            background: rgba(15, 23, 42, 0.9);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .radio-pill:has(input:checked) {
            background: var(--accent-soft-2);
            border-color: var(--accent);
        }

        .radio-pill input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        .intent-preset-dropdown {
            width: 100%;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-main);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }

        .intent-preset-dropdown:focus {
            border-color: var(--accent-soft-2);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .intent-preset-dropdown option {
            background: #0b1020;
            color: var(--text-main);
            padding: 8px;
        }

        .switch-sliders {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .slider-control {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slider-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .slider-value {
            font-size: 11px;
            color: var(--accent-strong);
            font-weight: 600;
            font-family: ui-monospace, monospace;
        }

        .slider-input {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 3px;
            outline: none;
            border: 1px solid var(--border-subtle);
        }

        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .slider-input::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--accent-soft-2);
            border: 1px solid var(--accent);
            border-radius: var(--radius-pill);
            font-size: 11px;
            color: var(--text-main);
        }

        .tag-remove {
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
        }

        .tag-remove:hover {
            color: var(--danger);
        }

        .pair-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pair-selector select {
            flex: 1;
        }

        .tag-list-area {
            width: 100%;
            min-height: 60px;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-main);
            font-size: 12px;
            font-family: ui-monospace, monospace;
            outline: none;
            resize: vertical;
        }

        .tag-list-area:focus {
            border-color: var(--accent-soft-2);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .code-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100%;
        }

        .code-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-title {
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .code-textarea {
            flex: 1;
            width: 100%;
            resize: none;
            font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 12px;
            line-height: 1.5;
            border-radius: var(--radius-md);
            padding: 12px;
            border: 1px solid var(--border-subtle);
            background: rgba(15, 23, 42, 0.98);
            color: var(--text-main);
            outline: none;
        }

        .code-textarea:focus {
            border-color: var(--accent-soft-2);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 12px;
            color: var(--text-soft);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 48px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 14px;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.9);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(75, 85, 99, 0.8);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.9);
        }

        .hidden {
            display: none !important;
        }

        .breadcrumb {
            font-size: 11px;
            color: var(--text-soft);
            margin-bottom: 12px;
            padding: 6px 10px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: var(--radius-pill);
            display: inline-block;
        }

        .breadcrumb strong {
            color: var(--accent-strong);
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">INTENT Data</div>
            </div>

            <div class="data-type-selector">
                <button class="data-type-btn active" onclick="window.switchType('characters', event)">Chars</button>
                <button class="data-type-btn" onclick="window.switchType('pairs', event)">Pairs</button>
                <button class="data-type-btn" onclick="window.switchType('dynamiclore', event)">Lore</button>
            </div>

            <div class="entries-list" id="entriesList"></div>

            <div class="sidebar-footer">
                <button type="button" class="pill-button small" onclick="window.createNew()">+ New</button>
                <button type="button" class="pill-button small" onclick="window.duplicate()">Dup</button>
                <button type="button" class="pill-button danger small" onclick="window.deleteEntry()">Del</button>
                <button type="button" class="pill-button small" onclick="window.addShift()" id="btnAddShift" style="display:none;">+ Shift</button>
            </div>
        </aside>

        <main class="main-panel">
            <header class="main-header">
                <div class="brand-block">
                    <div class="brand-title">INTENT Data Manager</div>
                </div>
                <div class="tab-toggle">
                    <button class="tab-button active" onclick="window.switchTab('visual')">Visual</button>
                    <button class="tab-button" onclick="window.switchTab('code')">Code</button>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="pill-button small" onclick="window.importData()">Import</button>
                    <button class="pill-button small success" onclick="window.exportData()">Export</button>
                </div>
            </header>

            <div class="main-content">
                <div id="visualEditor" class="editor-card">
                    <div class="empty-state">
                        <div class="empty-state-icon">üëà</div>
                        <div class="empty-state-text">Select an entry from the sidebar<br>or create a new one</div>
                    </div>
                </div>

                <div id="codeView" class="code-view hidden">
                    <div class="code-panel">
                        <div class="code-header">
                            <div class="code-title">Current Entry JSON</div>
                            <button class="pill-button small" onclick="window.syncFromJson()">‚Üê Sync</button>
                        </div>
                        <textarea class="code-textarea" id="entryJsonCode"></textarea>
                    </div>
                    <div class="code-panel">
                        <div class="code-header">
                            <div class="code-title">Full Export</div>
                            <button class="pill-button small" onclick="window.copyCode()">Copy</button>
                        </div>
                        <textarea class="code-textarea" id="fullExportCode" readonly></textarea>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <input type="file" id="fileInput" accept=".js,.txt" style="display:none;" onchange="window.handleFileImport(event)">

    <script>
// ============================================================================
// INTENT Data Manager ‚Äî patched for INTENT+ v15
// - Exports: ENTITY_DB, RELATIONSHIP_DB, DYNAMIC_LORE
// - Removes v7 neural switch sliders + presets
// - Adds v15 intent-gate dropdowns (INTENTS: question, disclosure, command, promise, conflict, smalltalk, meta, narrative)
// - Keeps: Characters, Pairs (Relationships), DynamicLore, Shifts, Import/Export, Code view
// ============================================================================

(function () {
  "use strict";

  // --------------------------------------------------------------------------
  // v15 intent set (as defined in INTENT+v15 docs)
  // --------------------------------------------------------------------------
  var INTENTS = ["question", "disclosure", "command", "promise", "conflict", "smalltalk", "meta", "narrative"];

  // --------------------------------------------------------------------------
  // App State
  // --------------------------------------------------------------------------
  var STATE = {
    templateText: null,
    type: "characters", // characters | pairs | dynamiclore
    entryId: null,
    shiftId: null,
    data: {
      characters: [],
      pairs: [],
      dynamiclore: []
    }
  };

  // --------------------------------------------------------------------------
  // Utilities
  // --------------------------------------------------------------------------
  function id(prefix) {
    return prefix + "_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
  }

  function escHtml(s) {
    return (s == null ? "" : String(s))
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function toArray(v) {
    if (!v) return [];
    if (Array.isArray(v)) return v.slice();
    return [v];
  }

  function splitCsv(text) {
    if (!text) return [];
    return String(text)
      .split(",")
      .map(function (t) { return t.trim(); })
      .filter(Boolean);
  }

  function joinCsv(arr) {
    if (!arr || !arr.length) return "";
    return arr.join(", ");
  }

  function charKeys() {
    return STATE.data.characters.map(function (c) { return c.key; }).filter(Boolean);
  }

  function curr() {
    if (!STATE.entryId) return null;
    var arr = STATE.data[STATE.type];
    for (var i = 0; i < arr.length; i++) if (arr[i].id === STATE.entryId) return arr[i];
    return null;
  }

  function currShift() {
    if (!STATE.shiftId) return null;
    var e = curr();
    if (!e || !e.shifts) return null;
    for (var i = 0; i < e.shifts.length; i++) if (e.shifts[i].id === STATE.shiftId) return e.shifts[i];
    return null;
  }

  function save(patch) {
    var arr = STATE.data[STATE.type];
    for (var i = 0; i < arr.length; i++) {
      if (arr[i].id === STATE.entryId) {
        for (var k in patch) arr[i][k] = patch[k];
        renderList();
        renderCode();
        return;
      }
    }
  }

  function saveShift(patch) {
    var e = curr();
    if (!e || !e.shifts) return;
    for (var i = 0; i < e.shifts.length; i++) {
      if (e.shifts[i].id === STATE.shiftId) {
        for (var k in patch) e.shifts[i][k] = patch[k];
        renderList();
        renderCode();
        return;
      }
    }
  }

  // Helper: bracket matching for safe import slicing
  function findMatchingBracket(str, startPos, openChar, closeChar) {
    var depth = 1;
    for (var i = startPos + 1; i < str.length; i++) {
      if (str[i] === openChar) depth++;
      else if (str[i] === closeChar) {
        depth--;
        if (depth === 0) return i;
      }
    }
    return -1;
  }

  // --------------------------------------------------------------------------
  // Navigation / Tabs
  // --------------------------------------------------------------------------
  window.switchType = function (type, e) {
    STATE.type = type;
    STATE.entryId = null;
    STATE.shiftId = null;

    var btns = document.querySelectorAll(".data-type-btn");
    for (var i = 0; i < btns.length; i++) btns[i].classList.remove("active");
    if (e && e.target) e.target.classList.add("active");

    document.getElementById("btnAddShift").style.display = type === "dynamiclore" ? "inline-flex" : "none";

    renderList();
    renderEditor();
    renderCode();
  };

  window.switchTab = function (tab) {
    var vis = document.getElementById("visualEditor");
    var code = document.getElementById("codeView");
    var btns = document.querySelectorAll(".tab-button");
    if (tab === "visual") {
      vis.classList.remove("hidden");
      code.classList.add("hidden");
      btns[0].classList.add("active");
      btns[1].classList.remove("active");
    } else {
      vis.classList.add("hidden");
      code.classList.remove("hidden");
      btns[0].classList.remove("active");
      btns[1].classList.add("active");
      renderCode();
    }
  };

  window.selectEntry = function (entryId, shiftId) {
    STATE.entryId = entryId;
    STATE.shiftId = shiftId || null;
    renderList();
    renderEditor();
    renderCode();
  };

  // --------------------------------------------------------------------------
  // CRUD
  // --------------------------------------------------------------------------
  window.createNew = function () {
    var newId = id(STATE.type);
    var newEntry;

    if (STATE.type === "characters") {
      newEntry = { id: newId, key: "", gender: "N", aliases: [], personality: "" };
    } else if (STATE.type === "pairs") {
      newEntry = { id: newId, pair: ["", ""], requireTags: [], injection: "", group: "" };
    } else {
      newEntry = {
        id: newId,
        id_name: "",
        priority: 2,
        group: "",
        keywords: [],
        tag: "",
        triggers: [],
        probability: "",
        block: [],
        andAny: [],
        andAll: [],
        notAll: [],
        andNone: [],
        andAnyIntent: [],
        andAllIntent: [],
        notAnyIntent: [],
        notAllIntent: [],
        personality: "",
        scenario: "",
        characters: [],
        shifts: []
      };
    }

    STATE.data[STATE.type].push(newEntry);
    STATE.entryId = newId;
    STATE.shiftId = null;

    renderList();
    renderEditor();
    renderCode();
  };

  window.duplicate = function () {
    var entry = curr();
    if (!entry) return;
    var clone = JSON.parse(JSON.stringify(entry));
    clone.id = id(STATE.type);
    if (STATE.type === "characters" && clone.key) clone.key = String(clone.key) + "_copy";
    if (STATE.type === "dynamiclore" && clone.id_name) clone.id_name = String(clone.id_name) + "_copy";
    STATE.data[STATE.type].push(clone);
    STATE.entryId = clone.id;
    STATE.shiftId = null;
    renderList();
    renderEditor();
    renderCode();
  };

  window.deleteEntry = function () {
    if (STATE.shiftId) {
      var e = curr();
      if (!e || !e.shifts) return;
      for (var i = 0; i < e.shifts.length; i++) {
        if (e.shifts[i].id === STATE.shiftId) {
          e.shifts.splice(i, 1);
          STATE.shiftId = null;
          renderList();
          renderEditor();
          renderCode();
          return;
        }
      }
      return;
    }

    if (!STATE.entryId) {
      alert("No entry selected");
      return;
    }

    var arr = STATE.data[STATE.type];
    for (var i = 0; i < arr.length; i++) {
      if (arr[i].id === STATE.entryId) {
        arr.splice(i, 1);
        STATE.entryId = null;
        STATE.shiftId = null;
        renderList();
        renderEditor();
        renderCode();
        return;
      }
    }
  };

  window.addShift = function () {
    if (STATE.type !== "dynamiclore") return;
    var e = curr();
    if (!e) { alert("Please select a lore entry first"); return; }
    if (!e.shifts) e.shifts = [];

    var shift = {
      id: id("shift"),
      id_name: "",
      priority: null,
      group: "",
      keywords: [],
      tag: "",
      triggers: [],
      probability: "",
      block: [],
      andAny: [],
      andAll: [],
      notAll: [],
      andNone: [],
      andAnyIntent: [],
      andAllIntent: [],
      notAnyIntent: [],
      notAllIntent: [],
      personality: "",
      scenario: "",
      characters: []
    };

    e.shifts.push(shift);
    STATE.shiftId = shift.id;
    renderList();
    renderEditor();
    renderCode();
  };

  // --------------------------------------------------------------------------
  // Import / Export
  // --------------------------------------------------------------------------
  window.exportData = function () {
    var txt = genExport();
    var blob = new Blob([txt], { type: "text/javascript" });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = "intent_v15_export.js";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  window.importData = function () {
    document.getElementById("fileInput").click();
  };

  window.handleFileImport = function (e) {
    var file = e.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function (ev) {
      try {
        parseImport(ev.target.result);
        STATE.templateText = ev.target.result;
        alert("Import successful!");
        renderList();
        renderEditor();
        renderCode();
      } catch (err) {
        alert("Import error: " + err.message);
        console.error("Import error:", err);
      }
    };
    reader.readAsText(file);
  };

  window.copyCode = function () {
    var code = document.getElementById("fullExportCode");
    code.select();
    document.execCommand("copy");
    alert("Copied!");
  };

  window.syncFromJson = function () {
    try {
      var json = JSON.parse(document.getElementById("entryJsonCode").value);
      if (!STATE.entryId) return;
      save(json);
      renderEditor();
      alert("Synced!");
    } catch (e) {
      alert("Invalid JSON: " + e.message);
    }
  };

  function genExport() {
    // If the user imported a full INTENT script, patch into that script so Export stays fully working.
    if (STATE.templateText && typeof STATE.templateText === "string" && STATE.templateText.length > 0) {
      return patchFullFile(STATE.templateText);
    }
    return genBlocksExport();
  }

  function genBlocksExport() {
    var out = [];

    // ENTITY_DB
    out.push("// ENTITY_DB");
    out.push("const ENTITY_DB = {");
    for (var i = 0; i < STATE.data.characters.length; i++) {
      var c = STATE.data.characters[i];
      if (!c.key) continue;
      var meta = {
        gender: c.gender || "N",
        aliases: (c.aliases && c.aliases.length) ? c.aliases.slice() : []
      };
      if (c.personality && String(c.personality).trim()) {
        meta.lore = [{
          group: (c.key + "_base"),
          keywords: ["char." + c.key],
          personality: c.personality
        }];
      } else {
        meta.lore = [{
          group: (c.key + "_base"),
          keywords: ["char." + c.key],
          personality: ""
        }];
      }
      out.push('  "' + c.key + '": ' + JSON.stringify(meta, null, 2).split("\n").join("\n  ") + (i < STATE.data.characters.length - 1 ? "," : ""));
    }
    out.push("};");
    out.push("");

    // RELATIONSHIP_DB
    out.push("// RELATIONSHIP_DB");
    out.push("const RELATIONSHIP_DB = [");
    for (var j = 0; j < STATE.data.pairs.length; j++) {
      var p = STATE.data.pairs[j];
      var cleanP = {
        pair: p.pair || ["", ""],
        requireTags: p.requireTags || [],
        injection: p.injection || "",
        group: p.group || ""
      };
      out.push("  " + JSON.stringify(cleanP, null, 2).split("\n").join("\n  ") + (j < STATE.data.pairs.length - 1 ? "," : ""));
    }
    out.push("];");
    out.push("");

    // DYNAMIC_LORE
    out.push("// DYNAMIC_LORE");
    out.push("const DYNAMIC_LORE = [");
    for (var k = 0; k < STATE.data.dynamiclore.length; k++) {
      var l = STATE.data.dynamiclore[k];
      var cleanL = stripLoreForExport(l, true);
      out.push("  " + JSON.stringify(cleanL, null, 2).split("\n").join("\n  ") + (k < STATE.data.dynamiclore.length - 1 ? "," : ""));
    }
    out.push("];");

    return out.join("\n");
  }

  function patchFullFile(src) {
    // Replace the three exported blocks inside the imported script.
    // We do bracket matching instead of brittle regex.
    var patched = src;

    patched = replaceConstBlock(patched, "ENTITY_DB", "{", "}", genEntityDbBlock());
    patched = replaceConstBlock(patched, "RELATIONSHIP_DB", "[", "]", genRelationshipDbBlock());
    patched = replaceConstBlock(patched, "DYNAMIC_LORE", "[", "]", genDynamicLoreBlock());

    return patched;
  }

  function replaceConstBlock(src, constName, openChar, closeChar, newBlockText) {
    var needle = "const " + constName + " = ";
    var idx = src.indexOf(needle);
    if (idx < 0) return src;

    // Find start of the opening bracket after '='
    var start = src.indexOf(openChar, idx);
    if (start < 0) return src;

    var end = findMatchingBracket(src, start, openChar, closeChar);
    if (end < 0) return src;

    // Include trailing semicolon if present.
    var after = end + 1;
    while (after < src.length && /\s/.test(src.charAt(after))) after++;
    if (src.charAt(after) === ";") after++;

    return src.slice(0, idx) + newBlockText + src.slice(after);
  }

  function genEntityDbBlock() {
    var out = [];
    out.push("const ENTITY_DB = {");
    // Keep stable order: as listed
    for (var i = 0; i < STATE.data.characters.length; i++) {
      var c = STATE.data.characters[i];
      if (!c.key) continue;
      var meta = {
        gender: c.gender || "N",
        aliases: (c.aliases && c.aliases.length) ? c.aliases.slice() : []
      };
      meta.lore = [{
        group: (c.key + "_base"),
        keywords: ["char." + c.key],
        personality: (c.personality || "")
      }];
      out.push('  "' + c.key + '": ' + JSON.stringify(meta, null, 2).split("\n").join("\n  ") + (i < STATE.data.characters.length - 1 ? "," : ""));
    }
    out.push("};");
    return out.join("\n");
  }

  function genRelationshipDbBlock() {
    var out = [];
    out.push("const RELATIONSHIP_DB = [");
    for (var j = 0; j < STATE.data.pairs.length; j++) {
      var p = STATE.data.pairs[j];
      var cleanP = {
        pair: p.pair || ["", ""],
        requireTags: p.requireTags || [],
        injection: p.injection || "",
        group: p.group || ""
      };
      out.push("  " + JSON.stringify(cleanP, null, 2).split("\n").join("\n  ") + (j < STATE.data.pairs.length - 1 ? "," : ""));
    }
    out.push("];");
    return out.join("\n");
  }

  function genDynamicLoreBlock() {
    var out = [];
    out.push("const DYNAMIC_LORE = [");
    for (var k = 0; k < STATE.data.dynamiclore.length; k++) {
      var l = STATE.data.dynamiclore[k];
      var cleanL = stripLoreForExport(l, true);
      out.push("  " + JSON.stringify(cleanL, null, 2).split("\n").join("\n  ") + (k < STATE.data.dynamiclore.length - 1 ? "," : ""));
    }
    out.push("];");
    return out.join("\n");
  }

  function stripLoreForExport(l, includeShifts) {
    var o = {};
    // id/name helpers
    if (l.id_name && String(l.id_name).trim()) o.id = l.id_name;

    if (l.group && String(l.group).trim()) o.group = l.group;
    if (l.priority != null && l.priority !== 0) o.priority = l.priority;

    if (l.keywords && l.keywords.length) o.keywords = l.keywords.slice();
    if (l.tag && String(l.tag).trim()) o.tag = l.tag;
    if (l.triggers && l.triggers.length) o.triggers = l.triggers.slice();
    if (l.probability && String(l.probability).trim()) o.probability = l.probability;
    if (l.block && l.block.length) o.block = l.block.slice();

    // Tag gates (INTENT+v15): andAll / notAny / notAll
    if (l.andAll && l.andAll.length) o.andAll = l.andAll.slice();
    // notAny is intentionally synonymous with block in this manager
    if (l.block && l.block.length) o.notAny = l.block.slice();
    if (l.notAll && l.notAll.length) o.notAll = l.notAll.slice();

    // v15 intent gates (export as these names)
    if (l.andAnyIntent && l.andAnyIntent.length) o.andAnyIntent = l.andAnyIntent.slice();
    if (l.andAllIntent && l.andAllIntent.length) o.andAllIntent = l.andAllIntent.slice();
    if (l.notAnyIntent && l.notAnyIntent.length) o.notAnyIntent = l.notAnyIntent.slice();
    if (l.notAllIntent && l.notAllIntent.length) o.notAllIntent = l.notAllIntent.slice();

    if (l.characters && l.characters.length) o.characters = l.characters.slice();

    if (l.personality && String(l.personality).length) o.personality = l.personality;
    if (l.scenario && String(l.scenario).length) o.scenario = l.scenario;

    if (includeShifts && l.shifts && l.shifts.length) {
      o.Shifts = [];
      for (var i = 0; i < l.shifts.length; i++) o.Shifts.push(stripLoreForExport(l.shifts[i], false));
    }
    return o;
  }

  function parseImport(txt) {
    // Reset
    STATE.data.characters = [];
    STATE.data.pairs = [];
    STATE.data.dynamiclore = [];
    STATE.entryId = null;
    STATE.shiftId = null;

    // ENTITY_DB
    var entIdx = txt.indexOf("const ENTITY_DB = {");
    if (entIdx >= 0) {
      var entStart = txt.indexOf("{", entIdx);
      var entEnd = findMatchingBracket(txt, entStart, "{", "}");
      if (entEnd >= 0) {
        var entBlock = txt.substring(entStart, entEnd + 1);
        var ENTITY_DB = eval("(" + entBlock + ")");
        for (var name in ENTITY_DB) {
          if (!Object.prototype.hasOwnProperty.call(ENTITY_DB, name)) continue;
          var meta = ENTITY_DB[name] || {};
          var basePersonality = "";
          if (meta.lore && meta.lore.length && meta.lore[0] && meta.lore[0].personality != null) {
            basePersonality = meta.lore[0].personality;
          }
          STATE.data.characters.push({
            id: id("char"),
            key: name,
            gender: meta.gender || "N",
            aliases: toArray(meta.aliases).filter(Boolean),
            personality: basePersonality || ""
          });
        }
      }
    }

    // RELATIONSHIP_DB
    var relIdx = txt.indexOf("const RELATIONSHIP_DB = [");
    if (relIdx >= 0) {
      var relStart = txt.indexOf("[", relIdx);
      var relEnd = findMatchingBracket(txt, relStart, "[", "]");
      if (relEnd >= 0) {
        var relBlock = txt.substring(relStart, relEnd + 1);
        var RELATIONSHIP_DB = eval(relBlock);
        for (var i = 0; i < RELATIONSHIP_DB.length; i++) {
          var r = RELATIONSHIP_DB[i] || {};
          STATE.data.pairs.push({
            id: id("pair"),
            pair: r.pair || ["", ""],
            requireTags: r.requireTags || r.andAll || r.andAny || [],
            injection: r.injection || r.scenario || "",
            group: r.group || ""
          });
        }
      }
    }

    // DYNAMIC_LORE
    var loreIdx = txt.indexOf("const DYNAMIC_LORE = [");
    if (loreIdx >= 0) {
      var loreStart = txt.indexOf("[", loreIdx);
      var loreEnd = findMatchingBracket(txt, loreStart, "[", "]");
      if (loreEnd >= 0) {
        var loreBlock = txt.substring(loreStart, loreEnd + 1);
        var DYNAMIC_LORE = eval(loreBlock);
        for (var j = 0; j < DYNAMIC_LORE.length; j++) {
          var e = DYNAMIC_LORE[j] || {};
          var entry = inflateLoreFromImport(e);
          STATE.data.dynamiclore.push(entry);
        }
      }
    }
  }

  function inflateLoreFromImport(e) {
    var entry = {
      id: id("lore"),
      id_name: e.id || e.id_name || "",
      priority: e.priority || 0,
      group: e.group || "",
      keywords: e.keywords || [],
      tag: e.tag || "",
      triggers: e.triggers || [],
      probability: e.probability || "",
      block: (e.block || e.notAny || e.andNone || e.requireNone || e.ifNot || e.notTags || []),

      andAny: e.andAny || e.requireAny || [],
      andAll: e.andAll || e.requireAll || [],
      notAll: (e.notAll || []),
      andNone: [],

      andAnyIntent: e.andAnyIntent || e.requireAnyIntent || toArray(e.requireIntent),
      andAllIntent: e.andAllIntent || e.requireAllIntent || [],
      notAnyIntent: e.notAnyIntent || e.blockAnyIntent || toArray(e.blockIntent),
      notAllIntent: e.notAllIntent || e.blockAllIntent || [],

      personality: e.personality || "",
      scenario: e.scenario || "",
      characters: e.characters || [],
      shifts: []
    };

    if (e.Shifts && Array.isArray(e.Shifts)) {
      for (var i = 0; i < e.Shifts.length; i++) {
        var s = inflateLoreFromImport(e.Shifts[i] || {});
        // make it a shift (no nested Shifts expected)
        s.id = (e.Shifts[i] && e.Shifts[i].id) ? e.Shifts[i].id : id("shift");
        s.shifts = undefined;
        entry.shifts.push({
          id: s.id,
          id_name: s.id_name || "",
          priority: (e.Shifts[i] && e.Shifts[i].priority != null) ? e.Shifts[i].priority : null,
          group: s.group || "",
          keywords: s.keywords || [],
          tag: s.tag || "",
          triggers: s.triggers || [],
          probability: s.probability || "",
          block: s.block || [],
          andAny: s.andAny || [],
          andAll: s.andAll || [],
          notAll: s.notAll || [],
          andNone: [],
          andAnyIntent: s.andAnyIntent || [],
          andAllIntent: s.andAllIntent || [],
          notAnyIntent: s.notAnyIntent || [],
          notAllIntent: s.notAllIntent || [],
          personality: s.personality || "",
          scenario: s.scenario || "",
          characters: s.characters || []
        });
      }
    }

    return entry;
  }

  // --------------------------------------------------------------------------
  // Rendering
  // --------------------------------------------------------------------------
  function renderList() {
    var list = document.getElementById("entriesList");
    var arr = STATE.data[STATE.type];

    if (!arr || arr.length === 0) {
      list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><div class="empty-state-text">No entries</div></div>';
      return;
    }

    var html = "";
    for (var i = 0; i < arr.length; i++) {
      var e = arr[i];
      var title = "Unnamed";
      var sub = "";

      if (STATE.type === "characters") {
        title = e.key || "Unnamed";
        sub = (e.gender || "?") + " ¬∑ " + ((e.aliases && e.aliases.length) ? ("Aliases: " + e.aliases.length) : "No aliases");
      } else if (STATE.type === "pairs") {
        title = (e.pair && e.pair.length) ? (e.pair[0] + " & " + e.pair[1]) : "Unnamed";
        sub = (e.requireTags ? e.requireTags.length : 0) + " tag(s)" + (e.group ? (" ¬∑ " + e.group) : "");
      } else {
        title = e.id_name || "Unnamed";
        sub = "Priority " + (e.priority || 0) + (e.group ? (" ¬∑ Group: " + e.group) : "");
      }

      var active = (e.id === STATE.entryId && !STATE.shiftId) ? "active" : "";
      html += '<div class="entry-item ' + active + '" onclick="window.selectEntry(\'' + e.id + '\')">';
      html += '<div class="entry-item-title">' + escHtml(title) + "</div>";
      html += '<div class="entry-item-subtitle">' + escHtml(sub) + "</div>";
      html += "</div>";

      if (STATE.type === "dynamiclore" && e.shifts && e.shifts.length) {
        for (var j = 0; j < e.shifts.length; j++) {
          var s = e.shifts[j];
          var sActive = (e.id === STATE.entryId && s.id === STATE.shiftId) ? "active" : "";
          html += '<div class="entry-item shift-item ' + sActive + '" onclick="window.selectEntry(\'' + e.id + '\', \'' + s.id + '\')">';
          html += '<div class="entry-item-title">Shift: ' + escHtml(s.id_name || s.id || ("Shift " + (j + 1))) + "</div>";
          html += '<div class="entry-item-subtitle">Priority: ' + (s.priority != null ? s.priority : "inherit") + "</div>";
          html += "</div>";
        }
      }
    }

    list.innerHTML = html;
  }

  function renderEditor() {
    var ed = document.getElementById("visualEditor");
    var entry = curr();
    if (!entry) {
      ed.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üëà</div><div class="empty-state-text">Select an entry</div></div>';
      return;
    }

    if (STATE.shiftId) {
      renderShiftEditor(entry, currShift());
      return;
    }

    if (STATE.type === "characters") renderCharEditor(entry);
    else if (STATE.type === "pairs") renderPairEditor(entry);
    else renderLoreEditor(entry);
  }

  function renderCharEditor(e) {
    var ed = document.getElementById("visualEditor");
    var aliasesText = joinCsv(e.aliases || []);
    ed.innerHTML =
      '<div class="form-section">' +
        '<div class="section-title">Entity (ENTITY_DB)</div>' +
        '<div class="form-group">' +
          '<label class="form-label">Key</label>' +
          '<input class="form-input" value="' + escHtml(e.key || "") + '" oninput="window._saveCharKey(this.value)">' +
          '<div class="form-help">Lowercase identifier. Export becomes ENTITY_DB[\"key\"].</div>' +
        '</div>' +
        '<div class="form-grid">' +
          '<div class="form-group">' +
            '<label class="form-label">Gender</label>' +
            '<div class="radio-group">' +
              radioPill("gender", "M", e.gender === "M", "Male") +
              radioPill("gender", "F", e.gender === "F", "Female") +
              radioPill("gender", "N", e.gender === "N", "Neutral") +
            '</div>' +
          '</div>' +
          '<div class="form-group">' +
            '<label class="form-label">Aliases</label>' +
            '<textarea class="tag-list-area" oninput="window._saveCharAliases(this.value)">' + escHtml(aliasesText) + "</textarea>" +
            '<div class="form-help">Comma-separated aliases used by entity expansion (e.g., \"aves, avie\").</div>' +
          "</div>" +
        "</div>" +
        '<div class="form-group">' +
          '<label class="form-label">Base Personality (stored in ENTITY_DB[key].lore[0].personality)</label>' +
          '<textarea class="form-textarea" style="min-height:120px;" oninput="save({personality:this.value})">' + escHtml(e.personality || "") + "</textarea>" +
        "</div>" +
      "</div>";
  }

  function radioPill(name, value, checked, label) {
    return '<label class="radio-pill"><input type="radio" name="' + name + '" value="' + value + '" ' + (checked ? "checked" : "") + ' onchange="save({gender:\'' + value + '\'})"><span>' + label + "</span></label>";
  }

  window._saveCharKey = function (v) {
    v = String(v || "").trim().toLowerCase();
    save({ key: v });
  };

  window._saveCharAliases = function (v) {
    save({ aliases: splitCsv(v) });
  };

  function renderPairEditor(e) {
    var ed = document.getElementById("visualEditor");
    var chars = charKeys();
    var pair = e.pair || ["", ""];
    var requireTagsText = joinCsv(e.requireTags || []);

    var c1opts = '<option value="">Select</option>';
    var c2opts = '<option value="">Select</option>';
    for (var i = 0; i < chars.length; i++) {
      c1opts += '<option value="' + escHtml(chars[i]) + '" ' + (pair[0] === chars[i] ? "selected" : "") + ">" + escHtml(chars[i]) + "</option>";
      c2opts += '<option value="' + escHtml(chars[i]) + '" ' + (pair[1] === chars[i] ? "selected" : "") + ">" + escHtml(chars[i]) + "</option>";
    }

    ed.innerHTML =
      '<div class="form-section">' +
        '<div class="section-title">Relationship Trigger (RELATIONSHIP_DB)</div>' +
        '<div class="form-group">' +
          '<label class="form-label">Pair</label>' +
          '<div class="pair-selector">' +
            '<select class="form-select" onchange="window._savePairSide(0,this.value)">' + c1opts + "</select>" +
            "<span>+</span>" +
            '<select class="form-select" onchange="window._savePairSide(1,this.value)">' + c2opts + "</select>" +
          "</div>" +
        "</div>" +
        '<div class="form-grid">' +
          '<div class="form-group">' +
            '<label class="form-label">Require Tags</label>' +
            '<textarea class="tag-list-area" oninput="save({requireTags: window._splitCsv(this.value)})">' + escHtml(requireTagsText) + "</textarea>" +
            '<div class="form-help">Comma-separated tags that must be active (e.g., banter, teasing).</div>' +
          "</div>" +
          '<div class="form-group">' +
            '<label class="form-label">Group</label>' +
            '<input class="form-input" value="' + escHtml(e.group || "") + '" oninput="save({group:this.value})">' +
            '<div class="form-help">Optional grouping label for debugging / organization.</div>' +
          "</div>" +
        "</div>" +
        '<div class="form-group">' +
          '<label class="form-label">Injection</label>' +
          '<textarea class="form-textarea" style="min-height:140px;" oninput="save({injection:this.value})">' + escHtml(e.injection || "") + "</textarea>" +
        "</div>" +
      "</div>";
  }

  window._splitCsv = function (v) { return splitCsv(v); };

  window._savePairSide = function (idx, v) {
    var e = curr();
    if (!e) return;
    var p = e.pair && e.pair.length ? e.pair.slice() : ["", ""];
    p[idx] = v;
    save({ pair: p });
  };

  function renderLoreEditor(e) {
    var ed = document.getElementById("visualEditor");
    var chars = charKeys();
    var selectedChars = e.characters || [];

    var charCheckboxes = "";
    if (chars.length) {
      for (var i = 0; i < chars.length; i++) {
        var checked = selectedChars.indexOf(chars[i]) >= 0 ? "checked" : "";
        charCheckboxes += '<label class="radio-pill"><input type="checkbox" ' + checked + ' onchange="window._toggleLoreChar(\'' + chars[i] + '\')"><span>' + escHtml(chars[i]) + "</span></label>";
      }
    } else {
      charCheckboxes = '<div class="form-help">No entities defined yet. Create entities first.</div>';
    }

    ed.innerHTML =
      '<div class="form-section">' +
        '<div class="section-title">Lore Entry (DYNAMIC_LORE)</div>' +
        '<div class="form-grid">' +
          '<div class="form-group">' +
            '<label class="form-label">ID Name (optional)</label>' +
            '<input class="form-input" value="' + escHtml(e.id_name || "") + '" oninput="save({id_name:this.value})">' +
          "</div>" +
          '<div class="form-group">' +
            '<label class="form-label">Priority</label>' +
            '<input type="number" class="form-input" value="' + escHtml(e.priority || 0) + '" oninput="save({priority:parseInt(this.value)||0})">' +
          "</div>" +
          '<div class="form-group">' +
            '<label class="form-label">Group</label>' +
            '<input class="form-input" value="' + escHtml(e.group || "") + '" oninput="save({group:this.value})">' +
          "</div>" +
        "</div>" +
      "</div>" +

      '<div class="form-section">' +
        '<div class="section-title">Keyword + Tag Controls</div>' +
        '<div class="form-grid">' +
          '<div class="form-group">' +
            '<label class="form-label">keywords</label>' +
            '<textarea class="tag-list-area" oninput="save({keywords: window._splitCsv(this.value)})">' + escHtml(joinCsv(e.keywords || [])) + "</textarea>" +
            '<div class="form-help">Comma-separated keyword phrases.</div>' +
          "</div>" +
          '<div class="form-group">' +
            '<label class="form-label">tag</label>' +
            '<input class="form-input" value="' + escHtml(e.tag || "") + '" oninput="save({tag:this.value})">' +
            '<div class="form-help">Trigger-only entry tag (optional).</div>' +
          "</div>" +
        "</div>" +
        '<div class="form-grid">' +
          '<div class="form-group">' +
            '<label class="form-label">triggers</label>' +
            '<textarea class="tag-list-area" oninput="save({triggers: window._splitCsv(this.value)})">' + escHtml(joinCsv(e.triggers || [])) + "</textarea>" +
            '<div class="form-help">Tags to emit when this entry fires (comma-separated).</div>' +
          "</div>" +
          '<div class="form-group">' +
            '<label class="form-label">probability</label>' +
            '<input class="form-input" value="' + escHtml(e.probability || "") + '" oninput="save({probability:this.value})">' +
            '<div class="form-help">Example: \"40%\" (optional).</div>' +
          "</div>" +
          '<div class="form-group">' +
            '<label class="form-label">block</label>' +
            '<textarea class="tag-list-area" oninput="save({block: window._splitCsv(this.value)})">' + escHtml(joinCsv(e.block || [])) + "</textarea>" +
            '<div class="form-help">Blocks if ANY of these tokens/tags are present.</div>' +
          "</div>" +
        "</div>" +
      "</div>" +


      '<div class="form-section">' +
        '<div class="section-title">Personality</div>' +
        '<textarea class="form-textarea" style="min-height:120px;" oninput="save({personality:this.value})">' + escHtml(e.personality || "") + "</textarea>" +
      "</div>" +

      '<div class="form-section">' +
        '<div class="section-title">Scenario</div>' +
        '<textarea class="form-textarea" style="min-height:140px;" oninput="save({scenario:this.value})">' + escHtml(e.scenario || "") + "</textarea>" +
      "</div>" +

'<div class="form-section">' +
        '<div class="section-title">Tag Gates</div>' +
        gateTextarea("andAll", "andAll (require ALL tags)", e.andAll) +
        gateTextarea("notAll", "notAll (block if ALL tags present)", e.notAll) +
        '<div class="form-help">Note: <strong>block</strong> above acts as notAny (block if ANY present).</div>' +
      "</div>" +

      '<div class="form-section">' +
        '<div class="section-title">Intent Gates (v15)</div>' +
        intentGatePicker("andAnyIntent", "andAnyIntent (require ANY intent)", e.andAnyIntent) +
        intentGatePicker("andAllIntent", "andAllIntent (require ALL intents)", e.andAllIntent) +
        intentGatePicker("notAnyIntent", "notAnyIntent (block if ANY intent)", e.notAnyIntent) +
        intentGatePicker("notAllIntent", "notAllIntent (block if ALL intents)", e.notAllIntent) +
        '<div class="form-help">Dropdowns write arrays of intent names. Engine accepts aliases like requireIntent/blockIntent too.</div>' +
      "</div>" +

      '<div class="form-section">' +
        '<div class="section-title">Entities (optional)</div>' +
        '<div class="form-group"><div class="radio-group">' + charCheckboxes + '</div><div class="form-help">If set, entry can be restricted to detected entities.</div></div>' +
      "</div>";

      if (e.shifts && e.shifts.length) {
      var shiftsHtml = '<div class="form-section"><div class="section-title">Shifts (' + e.shifts.length + ")</div>";
      for (var si = 0; si < e.shifts.length; si++) {
        var s = e.shifts[si];
        shiftsHtml +=
          '<div style="padding:8px;margin-bottom:6px;background:rgba(15,23,42,0.8);border:1px solid var(--border-subtle);border-left:3px solid var(--accent);border-radius:var(--radius-md);cursor:pointer;" onclick="window.selectEntry(\'' + e.id + '\', \'' + s.id + '\')">' +
            '<div style="font-size:12px;font-weight:600;">' + escHtml(s.id_name || s.id || ("Shift " + (si + 1))) + "</div>" +
            '<div style="font-size:10px;color:var(--text-soft);">Priority: ' + (s.priority != null ? s.priority : "inherit") + "</div>" +
          "</div>";
      }
      shiftsHtml += "</div>";
      ed.innerHTML += shiftsHtml;
    }
  }

  function gateTextarea(field, label, arr) {
    return (
      '<div class="form-group">' +
        '<label class="form-label">' + escHtml(field) + " (" + escHtml(label) + ")</label>" +
        '<textarea class="tag-list-area" oninput="save({' + field + ': window._splitCsv(this.value)})">' + escHtml(joinCsv(arr || [])) + "</textarea>" +
      "</div>"
    );
  }

  function intentGatePicker(field, label, selectedArr) {
    var sel = toArray(selectedArr).map(function (x) { return String(x).toLowerCase(); });

    var selectId = "intent_pick_" + field;
    var opts = '<option value="">Select intent‚Ä¶</option>';
    for (var i = 0; i < INTENTS.length; i++) {
      var intent = INTENTS[i];
      opts += '<option value="' + intent + '">' + intent + "</option>";
    }

    // Render selected list with remove buttons
    var listHtml = "";
    for (var j = 0; j < sel.length; j++) {
      var v = sel[j];
      if (!v) continue;
      listHtml +=
        '<div class="tag" style="margin-right:6px;margin-bottom:6px;">' +
          escHtml(v) +
          '<span class="tag-remove" title="Remove" onclick="window._intentRemove(\'' + field + '\', \'' + v + '\')">‚úï</span>' +
        "</div>";
    }
    if (!listHtml) listHtml = '<div class="form-help">No intents selected.</div>';

    return (
      '<div class="form-group">' +
        '<label class="form-label">' + escHtml(label) + "</label>" +
        '<div style="display:flex;gap:8px;align-items:center;">' +
          '<select id="' + selectId + '" class="form-select" style="flex:1;">' + opts + "</select>" +
          '<button type="button" class="pill-button small" onclick="window._intentAdd(\'' + field + '\', \'' + selectId + '\')">Add</button>' +
        "</div>" +
        '<div class="tag-cloud" style="margin-top:10px;">' + listHtml + "</div>" +
      "</div>"
    );
  }

  window._intentAdd = function (field, selectId) {
    var el = document.getElementById(selectId);
    if (!el) return;
    var v = (el.value || "").toLowerCase();
    if (!v) return;

    var e = curr();
    if (!e) return;

    var arr = toArray(e[field]).map(function (x) { return String(x).toLowerCase(); });
    if (arr.indexOf(v) < 0) arr.push(v);

    var patch = {};
    patch[field] = arr;
    save(patch);

    // reset selector
    el.value = "";

    // refresh UI so pills appear immediately
    try { renderEditor(); } catch (e) {}
  };

  window._intentRemove = function (field, v) {
    v = String(v || "").toLowerCase();
    var e = curr();
    if (!e) return;

    var arr = toArray(e[field]).map(function (x) { return String(x).toLowerCase(); });
    var idx = arr.indexOf(v);
    if (idx >= 0) arr.splice(idx, 1);

    var patch = {};
    patch[field] = arr;
    save(patch);

    // refresh UI so pills update immediately
    try { renderEditor(); } catch (e) {}
  };

  window._toggleLoreChar = function (name) {
    var e = curr();
    if (!e) return;
    var arr = e.characters ? e.characters.slice() : [];
    var idx = arr.indexOf(name);
    if (idx >= 0) arr.splice(idx, 1);
    else arr.push(name);
    save({ characters: arr });
  };

  function renderShiftEditor(parentEntry, shift) {
    if (!shift) return;
    var ed = document.getElementById("visualEditor");

    var bc = '<div class="breadcrumb">Editing Shift of <strong>' + escHtml(parentEntry.id_name || parentEntry.id || "") + "</strong></div>";

    // character checkboxes
    var chars = charKeys();
    var selectedChars = shift.characters || [];
    var charCheckboxes = "";
    if (chars.length) {
      for (var i = 0; i < chars.length; i++) {
        var checked = selectedChars.indexOf(chars[i]) >= 0 ? "checked" : "";
        charCheckboxes += '<label class="radio-pill"><input type="checkbox" ' + checked + ' onchange="window._toggleShiftChar(\'' + chars[i] + '\')"><span>' + escHtml(chars[i]) + "</span></label>";
      }
    } else {
      charCheckboxes = '<div class="form-help">No entities defined yet. Create entities first.</div>';
    }

    ed.innerHTML =
      bc +
      '<div class="form-section">' +
        '<div class="section-title">Shift</div>' +
        '<div class="form-grid">' +
          '<div class="form-group">' +
            '<label class="form-label">Shift ID Name (optional)</label>' +
            '<input class="form-input" value="' + escHtml(shift.id_name || "") + '" oninput="saveShift({id_name:this.value})">' +
          "</div>" +
          '<div class="form-group">' +
            '<label class="form-label">Priority</label>' +
            '<input type="number" class="form-input" value="' + (shift.priority != null ? escHtml(shift.priority) : "") + '" oninput="saveShift({priority:this.value?parseInt(this.value):null})">' +
            '<div class="form-help">Leave blank to inherit</div>' +
          "</div>" +
          '<div class="form-group">' +
            '<label class="form-label">Group</label>' +
            '<input class="form-input" value="' + escHtml(shift.group || "") + '" oninput="saveShift({group:this.value})">' +
          "</div>" +
        "</div>" +
      "</div>" +

      '<div class="form-section">' +
        '<div class="section-title">Keyword + Tag Controls</div>' +
        '<div class="form-grid">' +
          '<div class="form-group">' +
            '<label class="form-label">keywords</label>' +
            '<textarea class="tag-list-area" oninput="saveShift({keywords: window._splitCsv(this.value)})">' + escHtml(joinCsv(shift.keywords || [])) + "</textarea>" +
          "</div>" +
          '<div class="form-group">' +
            '<label class="form-label">tag</label>' +
            '<input class="form-input" value="' + escHtml(shift.tag || "") + '" oninput="saveShift({tag:this.value})">' +
          "</div>" +
        "</div>" +
        '<div class="form-grid">' +
          '<div class="form-group">' +
            '<label class="form-label">triggers</label>' +
            '<textarea class="tag-list-area" oninput="saveShift({triggers: window._splitCsv(this.value)})">' + escHtml(joinCsv(shift.triggers || [])) + "</textarea>" +
          "</div>" +
          '<div class="form-group">' +
            '<label class="form-label">probability</label>' +
            '<input class="form-input" value="' + escHtml(shift.probability || "") + '" oninput="saveShift({probability:this.value})">' +
          "</div>" +
          '<div class="form-group">' +
            '<label class="form-label">block</label>' +
            '<textarea class="tag-list-area" oninput="saveShift({block: window._splitCsv(this.value)})">' + escHtml(joinCsv(shift.block || [])) + "</textarea>" +
          "</div>" +
        "</div>" +
      "</div>" +


      '<div class="form-section">' +
        '<div class="section-title">Tag Gates</div>' +
        '<div class="form-group"><label class="form-label">andAll</label><textarea class="tag-list-area" oninput="saveShift({andAll: window._splitCsv(this.value)})">' + escHtml(joinCsv(shift.andAll || [])) + "</textarea></div>" +
        '<div class="form-group"><label class="form-label">notAll</label><textarea class="tag-list-area" oninput="saveShift({notAll: window._splitCsv(this.value)})">' + escHtml(joinCsv(shift.notAll || [])) + "</textarea></div>" +
        '<div class="form-help">Note: <strong>block</strong> above acts as notAny (block if ANY present).</div>' +
      "</div>" +

'<div class="form-section">' +
        '<div class="section-title">Intent Gates (v15)</div>' +
        shiftIntentPicker("andAnyIntent", "andAnyIntent", shift.andAnyIntent) +
        shiftIntentPicker("andAllIntent", "andAllIntent", shift.andAllIntent) +
        shiftIntentPicker("notAnyIntent", "notAnyIntent", shift.notAnyIntent) +
        shiftIntentPicker("notAllIntent", "notAllIntent", shift.notAllIntent) +
      "</div>" +

      '<div class="form-section">' +
        '<div class="section-title">Entities (optional)</div>' +
        '<div class="form-group"><div class="radio-group">' + charCheckboxes + '</div></div>' +
      "</div>" +

      '<div class="form-section">' +
        '<div class="section-title">Shift Personality</div>' +
        '<textarea class="form-textarea" style="min-height:120px;" oninput="saveShift({personality:this.value})">' + escHtml(shift.personality || "") + "</textarea>" +
      "</div>" +

      '<div class="form-section">' +
        '<div class="section-title">Shift Scenario</div>' +
        '<textarea class="form-textarea" style="min-height:140px;" oninput="saveShift({scenario:this.value})">' + escHtml(shift.scenario || "") + "</textarea>" +
      "</div>" +

      '<div style="margin-top:20px;"><button class="pill-button small" onclick="STATE.shiftId=null;renderEditor();">‚Üê Back to Entry</button></div>';
  }

  function shiftIntentPicker(field, label, selectedArr) {
    var sel = toArray(selectedArr).map(function (x) { return String(x).toLowerCase(); });

    var selectId = "shift_intent_pick_" + field;
    var opts = '<option value="">Select intent‚Ä¶</option>';
    for (var i = 0; i < INTENTS.length; i++) {
      var intent = INTENTS[i];
      opts += '<option value="' + intent + '">' + intent + "</option>";
    }

    var listHtml = "";
    for (var j = 0; j < sel.length; j++) {
      var v = sel[j];
      if (!v) continue;
      listHtml +=
        '<div class="tag" style="margin-right:6px;margin-bottom:6px;">' +
          escHtml(v) +
          '<span class="tag-remove" title="Remove" onclick="window._shiftIntentRemove(\'' + field + '\', \'' + v + '\')">‚úï</span>' +
        "</div>";
    }
    if (!listHtml) listHtml = '<div class="form-help">No intents selected.</div>';

    return (
      '<div class="form-group">' +
        '<label class="form-label">' + escHtml(label) + "</label>" +
        '<div style="display:flex;gap:8px;align-items:center;">' +
          '<select id="' + selectId + '" class="form-select" style="flex:1;">' + opts + "</select>" +
          '<button type="button" class="pill-button small" onclick="window._shiftIntentAdd(\'' + field + '\', \'' + selectId + '\')">Add</button>' +
        "</div>" +
        '<div class="tag-cloud" style="margin-top:10px;">' + listHtml + "</div>" +
      "</div>"
    );
  }

  window._shiftIntentAdd = function (field, selectId) {
    var el = document.getElementById(selectId);
    if (!el) return;
    var v = (el.value || "").toLowerCase();
    if (!v) return;

    var s = currShift();
    if (!s) return;

    var arr = toArray(s[field]).map(function (x) { return String(x).toLowerCase(); });
    if (arr.indexOf(v) < 0) arr.push(v);

    var patch = {};
    patch[field] = arr;
    saveShift(patch);

    el.value = "";
  };

  window._shiftIntentRemove = function (field, v) {
    v = String(v || "").toLowerCase();
    var s = currShift();
    if (!s) return;

    var arr = toArray(s[field]).map(function (x) { return String(x).toLowerCase(); });
    var idx = arr.indexOf(v);
    if (idx >= 0) arr.splice(idx, 1);

    var patch = {};
    patch[field] = arr;
    saveShift(patch);
  };

  window._toggleShiftChar = function (name) {
    var s = currShift();
    if (!s) return;
    var arr = s.characters ? s.characters.slice() : [];
    var idx = arr.indexOf(name);
    if (idx >= 0) arr.splice(idx, 1);
    else arr.push(name);
    saveShift({ characters: arr });
  };

  // --------------------------------------------------------------------------
  // Code View
  // --------------------------------------------------------------------------
  function renderCode() {
    var eJson = document.getElementById("entryJsonCode");
    var full = document.getElementById("fullExportCode");
    var entry = curr();

    if (entry) {
      var clean = JSON.parse(JSON.stringify(entry));
      delete clean.id;
      eJson.value = JSON.stringify(clean, null, 2);
    } else {
      eJson.value = "";
    }
    full.value = genExport();
  }

  // --------------------------------------------------------------------------
  // Boot
  // --------------------------------------------------------------------------
  window.onload = function () {
    renderList();
    renderEditor();
    renderCode();
  };

  // expose for back button in shift editor (kept compatible with inline onclick)
  window.STATE = STATE;
  window.renderEditor = renderEditor;
  window.renderList = renderList;
  window.renderCode = renderCode;
  window.save = save;
  window.saveShift = saveShift;

})();
</script>
</body>
</html>